{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fresh Corridor Nexus | Smart Urban Logistics</title>

    <!-- CesiumJS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;700&family=Rajdhani:wght@500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'core/css/styles.css' %}">
</head>

<body class="cyber-theme">
    <!-- Ensure CSRF Cookie is set -->
    <div style="display:none;">{% csrf_token %}</div>
    <div class="bg-grid-animation"></div>
    <div class="glow-orb" style="top: -10%; left: -10%;"></div>
    <div class="glow-orb" style="bottom: -10%; right: -10%; background: var(--secondary-glow);"></div>

    <nav class="navbar">
        <div class="brand-logo"
            style="display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1.4rem; color: #fff; text-shadow: 0 0 10px rgba(0, 243, 255, 0.3);">
            <img src="{% static 'core/images/logo.png' %}" alt="GeoAnushasan Logo"
                style="height: 72px; width: 72px; border-radius: 12px; object-fit: contain; background: rgba(255,255,255,0.05); padding: 6px; border: 2px solid var(--primary-color); box-shadow: 0 0 20px rgba(0, 243, 255, 0.5);">
            <span style="letter-spacing: 0.5px;">GeoAnushasan</span>
        </div>
        <div class="nav-tabs">
            <div id="btn-urban" class="nav-tab active" onclick="switchTab('urban', this)">Urban Nexus</div>
            <div id="btn-health" class="nav-tab" onclick="switchTab('health', this)">Health Monitor</div>
            <div id="btn-agri" class="nav-tab" onclick="switchTab('agri', this)">Agri-Logistics</div>
            <div id="btn-citizen" class="nav-tab" onclick="switchTab('citizen', this)">Citizen Connect</div>
        </div>

        <!-- Right Section: Weather + Profile -->
        <div style="display: flex; align-items: center; gap: 2rem;">
            <div class="weather-widget">
                <span id="header-weather-text">New Delhi | <strong>28¬∞C</strong></span>
            </div>

            <div class="profile-section" onclick="toggleProfileDropdown()"
                style="position: relative; cursor: pointer; display: flex; flex-direction: row; align-items: center; gap: 12px; padding: 6px 15px; border-radius: 99px; background: rgba(255,255,255,0.05); border: 1px solid var(--card-border); transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <div class="profile-photo"
                    style="width: 38px; height: 38px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary-color); overflow: hidden; box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary-color);">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div id="user-display-name-out"
                    style="font-size: 0.95rem; font-weight: 700; color: var(--text-main); white-space: nowrap; font-family: var(--font-head); letter-spacing: 0.5px;">
                    {{ user_name|default:"Planner" }}</div>
                <!-- Hidden fields to maintain JS compatibility -->
                <div id="user-display-email-out" style="display:none;"></div>
                <div id="user-display-aadhar-out" style="display:none;"></div>
            </div>
            <!-- Dropdown -->
            <div class="profile-dropdown" id="profile-dropdown">
                <div class="dropdown-profile-header">
                    <div class="dp-name">{{ user_name|default:"Planner" }}</div>
                    <div class="dp-email">{{ user_email|default:"user@example.com" }}</div>
                </div>

                <div class="dropdown-profile-body">
                    <div class="dp-item">
                        <span class="dp-label">Status</span>
                        <span class="badge bg-success">Active</span>
                    </div>
                    <div class="dp-item">
                        <span class="dp-label">Aadhar</span>
                        <span class="dp-value font-mono">{{ masked_aadhar|default:"xxxx xxxx xxxx xxxx" }}</span>
                    </div>
                </div>

                <a href="#" onclick="handleLogout()"><span class="material-icons-sharp">logout</span> Logout</a>
            </div>
        </div>
        </div>
    </nav>

    <div class="container">

        <!-- Tab 1: Urban Nexus (Cesium) -->
        <div id="urban" class="tab-content active">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem; align-items:center;">
                <h2 style="margin:0;">Urban Digital Twin</h2>
                <div style="font-size:0.9rem; color:var(--text-muted);">Real-time simulation environment</div>
            </div>
            <div class="card" style="padding:0; border:none; height:600px; position: relative;">
                <div id="cesiumContainer"></div>

                <!-- Route Traffic Analysis Panel -->
                <div id="route-analysis-panel"
                    style="position: absolute; top: 20px; right: 20px; background: rgba(10,11,20,0.9); border: 1px solid var(--card-border); padding: 1.2rem; border-radius: 8px; width: 320px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(10px);">
                    <h3
                        style="color:var(--text-main); margin-bottom:1rem; display: flex; align-items: center; gap: 0.5rem; font-family: var(--font-head);">
                        <span class="material-icons-sharp"
                            style="font-size: 1.2rem; color: var(--primary-color);">traffic</span> Route Analysis
                    </h3>

                    <div id="route-instructions"
                        style="background: rgba(0, 243, 255, 0.05); padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.85rem; color: var(--primary-color); border-left: 3px solid var(--primary-color);">
                        <strong>üìç Click on map to select points</strong><br>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">Select start and end points to check
                            distance & traffic.</span>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem; background: rgba(255,255,255,0.02); border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid rgba(255,255,255,0.05);">
                            <span
                                style="width: 24px; height: 24px; background: var(--success-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-weight: bold; font-size: 0.75rem;">A</span>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Start Point</div>
                                <div id="point-a-coords"
                                    style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                                    Not selected</div>
                            </div>
                        </div>
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem; background: rgba(255,255,255,0.02); border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
                            <span
                                style="width: 24px; height: 24px; background: var(--danger-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.75rem;">B</span>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">End Point</div>
                                <div id="point-b-coords"
                                    style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                                    Not selected</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <button id="analyze-route-btn" class="btn-primary"
                            style="flex: 1; justify-content: center; font-size: 0.9rem;" disabled>Analyze
                            Traffic</button>
                        <button id="clear-route-btn" class="btn-secondary"
                            style="padding: 0.6rem 1rem; font-size: 0.9rem;">Clear</button>
                    </div>

                    <!-- Loading State -->
                    <div id="route-loading" style="display: none; text-align: center; margin-top: 1rem;">
                        <div class="spinner"
                            style="width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 0.5rem;">
                        </div>
                        <span style="font-size: 0.8rem; color: #666;">Analyzing optimal route...</span>
                    </div>

                    <!-- Error State -->
                    <div id="route-error"
                        style="display: none; background: rgba(255, 0, 85, 0.1); color: var(--danger-color); padding: 0.8rem; border-radius: 6px; font-size: 0.85rem; margin-top: 1rem; border: 1px solid var(--danger-color);">
                    </div>

                    <div id="route-results" style="display: none;">
                        <div style="border-top: 1px solid var(--card-border); padding-top: 1rem; margin-top: 1rem;">
                            <!-- Congestion Level Header -->
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-main);">Congestion
                                    Level</div>
                                <div id="route-congestion-level" class="badge">--</div>
                            </div>

                            <!-- Simplified Result Grid -->
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; font-size: 0.85rem;">
                                <div style="background: rgba(255,255,255,0.02); padding: 0.5rem; border-radius: 4px;">
                                    <div style="color: var(--text-muted); margin-bottom: 0.2rem;">Avg Congestion</div>
                                    <div id="route-avg-congestion" style="font-weight: 600; color: var(--text-main);">--
                                    </div>
                                </div>
                                <div style="background: rgba(255,255,255,0.02); padding: 0.5rem; border-radius: 4px;">
                                    <div style="color: var(--text-muted); margin-bottom: 0.2rem;">Avg Speed</div>
                                    <div id="route-avg-speed" style="font-weight: 600; color: var(--text-main);">--
                                    </div>
                                </div>
                                <div style="background: rgba(255,255,255,0.02); padding: 0.5rem; border-radius: 4px;">
                                    <div style="color: var(--text-muted); margin-bottom: 0.2rem;">Distance</div>
                                    <div id="route-distance" style="font-weight: 600; color: var(--text-main);">--</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.02); padding: 0.5rem; border-radius: 4px;">
                                    <div style="color: var(--text-muted); margin-bottom: 0.2rem;">Est. Time</div>
                                    <div id="route-time" style="font-weight: 600; color: var(--text-main);">--</div>
                                </div>
                            </div>

                            <div style="margin-top: 0.8rem; font-size: 0.75rem; color: #94a3b8; text-align: center;">
                                Based on <span id="route-checkpoints">0</span> real-time checkpoints
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Urban Control Center Overlay (Title Only Initially, or Hidden) -->
                <!-- HIDDEN BY DEFAULT: Toggled by JS on Selection -->
                <div id="urban-control-center" class="urban-control-center"
                    style="position: absolute; top: 20px; left: 20px; background: rgba(10,11,20,0.92); border: 1px solid var(--card-border); border-radius: 12px; width: 380px; box-shadow: 0 12px 40px rgba(0,0,0,0.6); z-index: 999; display: none; flex-direction: column; overflow: hidden; max-height: 85vh; backdrop-filter: blur(15px);">

                    <!-- Header -->
                    <div
                        style="padding: 1.2rem; background: rgba(0, 243, 255, 0.1); border-bottom: 2px solid var(--primary-color); color: white; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3
                                style="margin:0; font-size:1.1rem; color:var(--primary-color); font-family:var(--font-head); letter-spacing:1px; text-transform:uppercase;">
                                Urban Control Center</h3>
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">Zone: <span
                                    id="ucc-zone-name" style="color:var(--text-main); font-weight:600;">Selected
                                    Zone</span></div>
                        </div>
                        <button onclick="closeUrbanControl()"
                            style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s;">&times;</button>
                    </div>

                    <!-- Tabs -->
                    <div
                        style="display:flex; background: rgba(255,255,255,0.03); border-bottom:1px solid var(--card-border);">
                        <button class="uc-tab active" onclick="switchUrbanTab('uc-weather', this)">Weather</button>
                        <button class="uc-tab" onclick="switchUrbanTab('uc-aqi', this)">AQI</button>
                        <button class="uc-tab" onclick="switchUrbanTab('uc-market', this)">Market</button>
                        <button class="uc-tab" onclick="switchUrbanTab('uc-health', this)">Health</button>
                    </div>

                    <!-- Content Area -->
                    <div style="flex:1; overflow-y:auto; padding:1rem;">

                        <!-- 1. WEATHER TAB -->
                        <div id="uc-weather" class="uc-content active">
                            <h4 style="margin-top:0;">Weather Conditions</h4>
                            <div class="sim-card">
                                <label>Current Condition</label>
                                <select id="sim-weather-type" class="form-select">
                                    <option value="clear">Clear Sky</option>
                                    <option value="rain">Heavy Rainfall (50mm/hr)</option>
                                    <option value="heat">Heatwave (>45¬∞C)</option>
                                    <option value="storm">Dust Storm</option>
                                </select>
                            </div>
                            <button class="btn-primary full-width" onclick="runUrbanSimulation('weather')">Simulate
                                Impact</button>
                            <div id="res-weather" class="sim-result" style="display:none;"></div>
                        </div>

                        <!-- 2. AQI TAB -->
                        <div id="uc-aqi" class="uc-content">
                            <h4 style="margin-top:0;">Air Quality Monitor</h4>
                            <div id="uc-aqi-list" class="mini-list">Loading stations...</div>

                            <hr style="margin:1rem 0; border:0; border-top:1px solid #eee;">

                            <h4 style="margin-top:0;">Simulation</h4>
                            <div class="sim-card">
                                <label>Simulate PM2.5 Spike</label>
                                <input type="range" id="sim-aqi-slider" min="50" max="500" value="100" class="slider"
                                    oninput="document.getElementById('sim-aqi-val').innerText = this.value">
                                <div style="text-align:right; font-weight:bold; color:var(--primary-color);">Level:
                                    <span id="sim-aqi-val">100</span>
                                </div>
                            </div>
                            <button class="btn-primary full-width" onclick="runUrbanSimulation('aqi')">Simulate Health
                                Impact</button>
                            <div id="res-aqi" class="sim-result" style="display:none;"></div>
                        </div>

                        <!-- 3. MARKET TAB -->
                        <div id="uc-market" class="uc-content">
                            <h4 style="margin-top:0;">Agri-Market Pulse</h4>
                            <div id="uc-market-list" class="mini-list">Loading market data...</div>

                            <hr style="margin:1rem 0; border:0; border-top:1px solid #eee;">

                            <h4 style="margin-top:0;">Supply Chain Simulation</h4>
                            <div class="sim-card">
                                <label>Event Scenario</label>
                                <select id="sim-market-event" class="form-select">
                                    <option value="normal">Normal Operations</option>
                                    <option value="blockade">Transport Strike (Supply -40%)</option>
                                    <option value="spoilage">Mass Spoilage (Loss -25%)</option>
                                </select>
                            </div>
                            <button class="btn-primary full-width" onclick="runUrbanSimulation('market')">Simulate Price
                                Impact</button>
                            <div id="res-market" class="sim-result" style="display:none;"></div>
                        </div>

                        <!-- 4. HEALTH TAB -->
                        <div id="uc-health" class="uc-content">
                            <h4 style="margin-top:0;">Hospital Grid</h4>
                            <div id="uc-health-list" class="mini-list">Loading hospitals...</div>

                            <hr style="margin:1rem 0; border:0; border-top:1px solid #eee;">

                            <h4 style="margin-top:0;">Emergency Simulation</h4>
                            <div class="sim-card">
                                <label>Emergency Type</label>
                                <select id="sim-health-event" class="form-select">
                                    <option value="normal">Normal Flow</option>
                                    <option value="surge">Epidemic Surge (Load +30%)</option>
                                    <option value="accident">Mass Casualty Event</option>
                                </select>
                            </div>
                            <button class="btn-primary full-width" onclick="runUrbanSimulation('health')">Simulate
                                Network
                                Load</button>
                            <div id="res-health" class="sim-result" style="display:none;"></div>
                        </div>

                    </div>
                </div>

                <!-- Guidance Overlay -->
                <div id="urban-hint"
                    style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.6); color:white; padding:10px 15px; border-radius:30px; font-size:0.9rem; pointer-events:none; z-index:998;">
                    üëà Select a <strong>Zone</strong> on the map to open Control Center
                </div>

                <!-- Resilience Score Panel (Top Center) -->
                <div id="resilience-panel"
                    style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); padding: 0.8rem 1.5rem; border-radius: 50px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 999; display:flex; align-items:center; gap:1.5rem; display:none;">
                    <div style="text-align:center;">
                        <div style="font-size:0.7rem; font-weight:700; color:#64748b; letter-spacing:1px;">OVERALL
                            RESILIENCE</div>
                        <div id="metric-overall"
                            style="font-size:1.8rem; font-weight:800; color:#10b981; line-height:1;">--</div>
                    </div>
                    <div style="width:1px; height:30px; background:#e2e8f0;"></div>
                    <div style="display:flex; gap:1rem;">
                        <div style="text-align:center;">
                            <div style="font-size:0.65rem; color:#64748b;">AQI Resilience</div>
                            <div id="metric-aqi" style="font-weight:600; color:#334155;">--</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:0.65rem; color:#64748b;">Med. Capacity</div>
                            <div id="metric-med" style="font-weight:600; color:#334155;">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Urban Nexus Dashboard Grid -->
            <div style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--text-main);">üèôÔ∏è Consolidated Urban Metrics</h3>
                <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));">

                    <!-- 1. Detailed Weather Card -->
                    <div class="card">
                        <h3>üå§Ô∏è Weather Conditions</h3>
                        <div
                            style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem;">
                            <div id="dash-weather-temp" style="font-size:3.5rem;">28¬∞C</div>
                            <div style="text-align:right;">
                                <div style="font-size:1.2rem; font-weight:600;">Partly Cloudy</div>
                                <div style="color:var(--text-muted);">RealFeel: 31¬∞C</div>
                            </div>
                        </div>
                        <div
                            style="display:flex; justify-content:space-between; background:rgba(255,255,255,0.05); padding:1rem; border-radius:8px;">
                            <div style="text-align:center;">
                                <div style="font-size:0.9rem; color:var(--text-muted);">Humidity</div>
                                <div style="font-weight:600;" id="dash-weather-hum">45%</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:0.9rem; color:var(--text-muted);">Wind</div>
                                <div style="font-weight:600;" id="dash-weather-wind">12 km/h</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:0.9rem; color:var(--text-muted);">UV Index</div>
                                <div style="font-weight:600;">Moderate</div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. AQI Hotspots Card -->
                    <div class="card">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                            <h3>üò∑ AQI Hotspots</h3>
                            <span class="badge bg-warning" id="dash-aqi-status">Moderate</span>
                        </div>
                        <div
                            style="display:flex; justify-content:space-between; padding:0.5rem; background:rgba(255,255,255,0.05); font-weight:600; font-size:0.85rem; border-radius:4px;">
                            <span>Station Name</span>
                            <span>Level</span>
                        </div>
                        <div id="dash-aqi-list" style="max-height: 200px; overflow-y: auto; margin-top:0.5rem;">
                            Loading hotspots...
                        </div>
                    </div>

                    <!-- 3. Market Rates Card -->
                    <div class="card">
                        <h3>üçÖ Mandi Live Rates</h3>
                        <div class="table-container" style="max-height:220px; overflow-y:auto;">
                            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                                <thead style="background:rgba(255,255,255,0.1); position:sticky; top:0;">
                                    <tr>
                                        <th style="text-align:left; padding:8px;">Commodity</th>
                                        <th style="text-align:right; padding:8px;">Price (‚Çπ/kg)</th>
                                        <th style="padding:8px;">Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-market-table">
                                    <tr>
                                        <td colspan="3" style="padding:10px; text-align:center;">Loading Market Data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 4. Hospital Status Card -->
                    <div class="card">
                        <h3>üè• Hospital Network Status</h3>
                        <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                            <div
                                style="flex:1; background:rgba(29, 78, 216, 0.1); padding:1rem; border-radius:8px; text-align:center;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#1d4ed8;" id="dash-beds-icu">--
                                </div>
                                <div style="font-size:0.85rem;">Available ICU</div>
                            </div>
                            <div
                                style="flex:1; background:rgba(21, 128, 61, 0.1); padding:1rem; border-radius:8px; text-align:center;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#15803d;" id="dash-beds-gen">--
                                </div>
                                <div style="font-size:0.85rem;">General Ward</div>
                            </div>
                        </div>
                        <div style="font-size:0.85rem; color:#64748b; text-align:center;">
                            Monitored Zones: Central, North, South-East
                        </div>
                    </div>

                </div>
            </div>

            <!-- Traffic Congestion Monitor -->
            <div style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--text-main);">üö¶ Real-Time Traffic Congestion Monitor</h3>

                <div class="traffic-controls card" style="margin-bottom: 1.5rem; padding: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                        <div style="flex: 1; min-width: 200px;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">Latitude:</label>
                            <input type="text" id="traffic-latitude" value="28.6139"
                                style="width: 100%; padding: 0.6rem; border: 2px solid var(--card-border); border-radius: 6px; font-size: 0.95rem; background: var(--bg-color); color: var(--text-main);">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">Longitude:</label>
                            <input type="text" id="traffic-longitude" value="77.2090"
                                style="width: 100%; padding: 0.6rem; border: 2px solid var(--card-border); border-radius: 6px; font-size: 0.95rem; background: var(--bg-color); color: var(--text-main);">
                        </div>
                        <button id="fetchTrafficBtn" class="btn-primary" style="padding: 0.6rem 1.5rem;">
                            Fetch Traffic Data
                        </button>
                        <button id="autoRefreshTrafficBtn" class="btn-secondary" style="padding: 0.6rem 1.5rem;">
                            üîÑ Monitor: OFF
                        </button>
                    </div>
                </div>

                <div id="traffic-loading" class="card" style="text-align: center; padding: 2rem; display: none;">
                    <div class="spinner"
                        style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;">
                    </div>
                    <p>Loading traffic data...</p>
                </div>

                <div id="traffic-error" class="card"
                    style="background: #fee; border: 2px solid #fcc; color: #c33; padding: 1rem; display: none;"></div>

                <div id="traffic-results" style="display: none;">
                    <div class="dashboard-grid">
                        <!-- Congestion Score Card -->
                        <div class="card" id="traffic-congestion-card"
                            style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; padding: 2rem; text-align: center;">
                            <h3 style="margin: 0 0 1rem 0; opacity: 0.9;">Congestion Score</h3>
                            <div id="traffic-congestion-score"
                                style="font-size: 4rem; font-weight: bold; margin: 1rem 0;">--</div>
                            <div id="traffic-congestion-label"
                                style="font-size: 1.2rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                                Loading...</div>
                            <div
                                style="width: 100%; height: 20px; background: rgba(255,255,255,0.3); border-radius: 10px; margin-top: 1.5rem; overflow: hidden;">
                                <div id="traffic-progress-fill"
                                    style="height: 100%; border-radius: 10px; transition: width 0.5s ease;"></div>
                            </div>
                        </div>

                        <!-- Current Speed -->
                        <div class="card">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 2.5rem;">üöó</div>
                                <div style="flex: 1;">
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.3rem;">
                                        Current Speed</div>
                                    <div id="traffic-current-speed"
                                        style="font-size: 1.8rem; font-weight: bold; color: var(--text-main);">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Free Flow Speed -->
                        <div class="card">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 2.5rem;">‚ö°</div>
                                <div style="flex: 1;">
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.3rem;">
                                        Free Flow Speed</div>
                                    <div id="traffic-free-flow-speed"
                                        style="font-size: 1.8rem; font-weight: bold; color: var(--text-main);">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Travel Time -->
                        <div class="card">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 2.5rem;">‚è±Ô∏è</div>
                                <div style="flex: 1;">
                                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.3rem;">
                                        Current Travel Time</div>
                                    <div id="traffic-current-time"
                                        style="font-size: 1.8rem; font-weight: bold; color: var(--text-main);">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Road Info -->
                        <div class="card">
                            <h4 style="margin: 0 0 1rem 0; color: var(--text-main);">Road Information</h4>
                            <div
                                style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--card-border);">
                                <span style="font-weight: 600; color: var(--text-muted);">Road Class:</span>
                                <span id="traffic-road-class" style="color: var(--text-main);">--</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--card-border);">
                                <span style="font-weight: 600; color: var(--text-muted);">Road Closure:</span>
                                <span id="traffic-road-closure" style="color: var(--text-main);">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="font-weight: 600; color: var(--text-muted);">Data Confidence:</span>
                                <span id="traffic-confidence" style="color: var(--text-main);">--</span>
                            </div>
                        </div>

                        <!-- Location Info -->
                        <div class="card">
                            <h4 style="margin: 0 0 1rem 0; color: var(--text-main);">Location Details</h4>
                            <div
                                style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--card-border);">
                                <span style="font-weight: 600; color: var(--text-muted);">Latitude:</span>
                                <span id="traffic-loc-lat" style="color: var(--text-main);">--</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--card-border);">
                                <span style="font-weight: 600; color: var(--text-muted);">Longitude:</span>
                                <span id="traffic-loc-lon" style="color: var(--text-main);">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="font-weight: 600; color: var(--text-muted);">Coordinates:</span>
                                <span id="traffic-coord-count" style="color: var(--text-main);">--</span>
                            </div>
                        </div>
                    </div>

                    <div id="traffic-last-updated"
                        style="text-align: center; padding: 1rem; margin-top: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.9rem; color: var(--text-muted);">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Health Monitor -->
        <div id="health" class="tab-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem; align-items:center;">
                <h2 style="margin:0;">Public Health Overview</h2>
                <button class="btn-primary" onclick="loadHealthData()">Refresh Data</button>
            </div>

            <!-- Health Tab Map -->
            <div class="card" style="padding:0; border:none; height:500px; margin-bottom:1.5rem; position:relative;">
                <div id="healthMapContainer" style="width:100%; height:100%;"></div>

                <!-- NEW: Toggle Controls -->
                <div
                    style="position:absolute; top:10px; left:10px; background:rgba(10,11,20,0.9); border:1px solid var(--card-border); padding:10px 15px; border-radius:8px; z-index:99; box-shadow:0 8px 16px rgba(0,0,0,0.4); backdrop-filter: blur(5px);">
                    <div
                        style="font-weight:700; color:var(--text-main); margin-bottom:8px; font-size:0.9rem; border-bottom:1px solid var(--card-border); padding-bottom:4px;">
                        Map Layers</div>
                    <label
                        style="display:flex; align-items:center; margin-bottom:4px; cursor:pointer; font-size:0.9rem; color:var(--text-muted);">
                        <input type="checkbox" id="toggle-hospitals" checked onchange="toggleMapLayer('hospital')"
                            style="margin-right:8px;"> Show Hospitals
                    </label>
                    <label
                        style="display:flex; align-items:center; margin-bottom:8px; cursor:pointer; font-size:0.9rem; color:var(--text-muted);">
                        <input type="checkbox" id="toggle-aqi" checked onchange="toggleMapLayer('aqi')"
                            style="margin-right:8px;"> Show AQI Stations
                    </label>

                    <div style="border-top:1px solid var(--card-border); padding-top:6px; margin-top:6px;">
                        <div style="font-size:0.8rem; font-weight:600; color:var(--text-main); margin-bottom:4px;">
                            Hospital Scale (<span id="scale-val">50</span>)
                        </div>
                        <input type="range" id="hospital-scale" min="10" max="500" value="50"
                            style="width:100%; cursor:pointer;"
                            oninput="document.getElementById('scale-val').innerText = this.value; toggleMapLayer('hospital')">
                        <div style="font-size:0.7rem; color:#64748b;">Show Top N by Beds</div>
                    </div>
                </div>

                <div
                    style="position:absolute; bottom:20px; right:20px; background:rgba(0,0,0,0.7); color:white; padding:10px; border-radius:8px; font-size:0.8rem;">
                    <div><span
                            style="display:inline-block; width:10px; height:10px; background:red; border-radius:50%;"></span>
                        Hospital (Critical)</div>
                    <div><span
                            style="display:inline-block; width:10px; height:10px; background:green; border-radius:50%;"></span>
                        Hospital (Stable)</div>
                    <div><span
                            style="display:inline-block; width:10px; height:10px; background:orange; border-radius:50%;"></span>
                        AQI Station</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <div class="stat-indicator" style="background: var(--danger-color);"></div>
                    <h3>ICU Occupancy</h3>
                    <div class="stat-value" style="color: var(--danger-color);" id="icu-total">--</div>
                    <div class="stat-label">Critical Care Beds</div>
                </div>
                <!-- ... existing cards ... -->
                <div class="card">
                    <div class="stat-indicator" style="background: var(--success-color);"></div>
                    <h3>General Ward</h3>
                    <div class="stat-value" style="color: var(--success-color);" id="general-total">--</div>
                    <div class="stat-label">Standard Beds</div>
                </div>
                <div class="card">
                    <div class="stat-indicator" style="background: var(--warning-color);"></div>
                    <h3>Avg Oxygen Supply</h3>
                    <div class="stat-value" style="color: var(--warning-color);" id="oxygen-avg">--</div>
                    <div class="stat-label">Stock Availability</div>
                </div>
            </div>

            <!-- Real-Time AQI Section -->
            <h2 style="margin-top:2rem;">Real-Time Environmental Data</h2>
            <div class="dashboard-grid">
                <div class="card">
                    <h3>AQI Hotspots (Top 5)</h3>
                    <div
                        style="display:flex; justify-content:space-between; padding:0.5rem; background:rgba(255,255,255,0.05); margin-bottom:0.5rem; font-weight:600; font-size:0.85rem; color:var(--text-muted); border-radius: 4px;">
                        <span>Station / Zone</span>
                        <span>AQI</span>
                    </div>
                    <div id="epi-list"
                        style="max-height: 400px; overflow-y: auto; color: var(--text-muted); padding: 1rem;">Loading
                        Real-Time Data...</div>
                </div>
                <div class="card">
                    <h3>Health Desert Alerts</h3>
                    <div id="desert-alerts" style="color: var(--text-muted); padding: 1rem;">Scanning...</div>
                </div>
            </div>

            <div class="card">
                <h3>Hospital Network Status</h3>
                <div class="table-container" style="background: rgba(255,255,255,0.02); border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--card-border); text-align: left;">
                                <th
                                    style="padding: 12px; color: var(--text-main); font-family: var(--font-head); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">
                                    Hospital Name</th>
                                <th
                                    style="padding: 12px; color: var(--text-main); font-family: var(--font-head); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">
                                    Zone</th>
                                <th
                                    style="padding: 12px; color: var(--text-main); font-family: var(--font-head); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">
                                    ICU Load</th>
                                <th
                                    style="padding: 12px; color: var(--text-main); font-family: var(--font-head); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">
                                    Status</th>
                            </tr>
                        </thead>
                        <tbody id="hospital-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 3: Agri Logistics -->
        <div id="agri" class="tab-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem; align-items:center;">
                <h2 style="margin:0;">Agri-Logistics Network</h2>
                <button class="btn-primary" onclick="loadAgriData()">Sync Logistics</button>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <div class="stat-indicator" style="background: #16a34a;"></div>
                    <h3>Active Shipments</h3>
                    <div class="stat-value" style="color: #16a34a;" id="agri-count">--</div>
                    <div class="stat-label">In Transit</div>
                </div>
                <div class="card">
                    <div class="stat-indicator" style="background: #ea580c;"></div>
                    <h3>Spoilage Risk</h3>
                    <div class="stat-value" style="color: #ea580c;" id="spoilage-risk">--</div>
                    <div class="stat-label">High Risk Shipments</div>
                </div>
            </div>

            <!-- VALIDATOR LIVE SECTION -->
            <div class="card" style="margin-bottom: 2rem; border-left: 4px solid #8b5cf6;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0; color: #7c3aed;">üí∞ Azadpur Live Rates (Validator Feed)</h3>
                    <span class="badge bg-warning" id="validator-status">Connecting to Port 8001...</span>
                </div>
                <div class="table-container" style="margin-top:1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Commodity</th>
                                <th>Modal Price (‚Çπ/kg)</th>
                                <th>City Stock (kg)</th>
                                <th>Trend</th>
                                <th>Alert</th>
                            </tr>
                        </thead>
                        <tbody id="validator-table">
                            <tr>
                                <td colspan="5" style="text-align:center; padding: 2rem; color: #64748b;">
                                    Waiting for Agri Validator Service...<br>
                                    <small>Please ensure `python manage.py runserver 8001` is running in `agri/`
                                        directory.</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>Incoming Supply Log</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Crop</th>
                                <th>Farmer</th>
                                <th>Origin</th>
                                <th>Quantity</th>
                                <th>Risk Score</th>
                            </tr>
                        </thead>
                        <tbody id="agri-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 4: Citizen -->
        <div id="citizen" class="tab-content">
            <h2 style="margin-bottom:1.5rem;">Citizen Connect Pulse</h2>

            <!-- Citizen Map (Cesium) -->
            <div class="card" style="padding:0; border:none; height:600px; margin-bottom:1.5rem; position:relative;">
                <div id="citizenMapContainer" style="width:100%; height:100%;"></div>

                <!-- COPIED: Route Traffic Analysis Panel (Citizen Version) -->
                <div id="cit-route-analysis-panel"
                    style="position: absolute; top: 20px; right: 20px; background: rgba(10,11,20,0.95); border: 1px solid var(--card-border); padding: 1.2rem; border-radius: 8px; width: 320px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 999; backdrop-filter: blur(10px);">
                    <h3
                        style="color:var(--text-main); margin-bottom:1rem; display: flex; align-items: center; gap: 0.5rem;">
                        üó∫Ô∏è Citizen Route Planner
                    </h3>

                    <div id="cit-route-instructions"
                        style="background: rgba(3, 105, 161, 0.1); padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.85rem; color: #7dd3fc; border-left: 3px solid #0284c7;">
                        <strong>üìç Click on map to select points</strong><br>
                        <span style="font-size: 0.8rem; opacity: 0.8;">Select start and end points to check distance &
                            traffic.</span>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 0.5rem;">
                            <span
                                style="width: 24px; height: 24px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.75rem;">A</span>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Start Point</div>
                                <div id="cit-point-a-coords"
                                    style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Not selected
                                </div>
                            </div>
                        </div>
                        <div
                            style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                            <span
                                style="width: 24px; height: 24px; background: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.75rem;">B</span>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">End Point</div>
                                <div id="cit-point-b-coords"
                                    style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">Not selected
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <button id="cit-analyze-route-btn" class="btn-primary"
                            style="flex: 1; justify-content: center; font-size: 0.9rem;" disabled>Analyze Route</button>
                        <button id="cit-clear-route-btn" class="btn-secondary"
                            style="padding: 0.6rem 1rem; font-size: 0.9rem;">Clear</button>
                    </div>

                    <div id="cit-route-loading" style="display: none; text-align: center; margin-top: 1rem;">
                        <div class="spinner"
                            style="width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 0.5rem;">
                        </div>
                        <span style="font-size: 0.8rem; color: #666;">Analyzing optimal route...</span>
                    </div>

                    <div id="cit-route-error"
                        style="display: none; background: #fee2e2; color: #b91c1c; padding: 0.8rem; border-radius: 6px; font-size: 0.85rem; margin-top: 1rem;">
                    </div>

                    <div id="cit-route-results" style="display: none;">
                        <div style="border-top: 2px solid var(--card-border); padding-top: 1rem; margin-top: 1rem;">
                            <!-- Simplified Result Grid -->
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; font-size: 0.85rem;">
                                <div>
                                    <div style="color: var(--text-muted); margin-bottom: 0.2rem;">Distance</div>
                                    <div id="cit-route-distance" style="font-weight: 600; color: var(--text-main);">--
                                    </div>
                                </div>
                                <div>
                                    <div style="color: var(--text-muted); margin-bottom: 0.2rem;">Est. Time</div>
                                    <div id="cit-route-time" style="font-weight: 600; color: var(--text-main);">--</div>
                                </div>
                                <div style="grid-column: span 2;">
                                    <div style="color: var(--text-muted); margin-bottom: 0.2rem;">Congestion Level</div>
                                    <div id="cit-route-avg-congestion"
                                        style="font-weight: bold; color: var(--primary-color);">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESTORED: Weather Monitor -->
            <h3 style="margin-bottom:1rem; color:var(--text-main);">‚òÅÔ∏è Real-Time Weather Monitor</h3>
            <div class="dashboard-grid"
                style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom:2rem;">

                <!-- 1. Temperature -->
                <div class="card" style="text-align:center;">
                    <div style="font-size:2rem;">üå°Ô∏è</div>
                    <div style="color:var(--text-muted); font-size:0.85rem; margin:5px 0;">Temperature</div>
                    <div id="w-temp" style="font-size:1.5rem; font-weight:bold; color:#f97316;">--¬∞C</div>
                    <small style="color:#94a3b8;">Avg: 30¬∞C</small>
                </div>

                <!-- 2. Humidity -->
                <div class="card" style="text-align:center;">
                    <div style="font-size:2rem;">üíß</div>
                    <div style="color:var(--text-muted); font-size:0.85rem; margin:5px 0;">Humidity</div>
                    <div id="w-humidity" style="font-size:1.5rem; font-weight:bold; color:#3b82f6;">--%</div>
                    <small style="color:#94a3b8;">Moist Air</small>
                </div>

                <!-- 3. Precipitation -->
                <div class="card" style="text-align:center;">
                    <div style="font-size:2rem;">üåßÔ∏è</div>
                    <div style="color:var(--text-muted); font-size:0.85rem; margin:5px 0;">Precipitation</div>
                    <div id="w-precip" style="font-size:1.5rem; font-weight:bold; color:#64748b;">--mm</div>
                    <small style="color:#94a3b8;">Last 24h</small>
                </div>

                <!-- 4. Pressure -->
                <div class="card" style="text-align:center;">
                    <div style="font-size:2rem;">‚è≤Ô∏è</div>
                    <div style="color:var(--text-muted); font-size:0.85rem; margin:5px 0;">Pressure</div>
                    <div id="w-pressure" style="font-size:1.5rem; font-weight:bold; color:#10b981;">-- hPa</div>
                    <small style="color:#94a3b8;">Barometer</small>
                </div>

                <!-- 5. Wind -->
                <div class="card" style="text-align:center;">
                    <div style="font-size:2rem;">üí®</div>
                    <div style="color:var(--text-muted); font-size:0.85rem; margin:5px 0;">Wind</div>
                    <div id="w-wind" style="font-size:1.3rem; font-weight:bold; color:#6366f1;">-- km/h</div>
                    <small id="w-dir" style="color:#94a3b8;">Direction: --</small>
                </div>



                <!-- 7. Visibility -->
                <div class="card" style="text-align:center;">
                    <div style="font-size:2rem;">üëÅÔ∏è</div>
                    <div style="color:var(--text-muted); font-size:0.85rem; margin:5px 0;">Visibility</div>
                    <div id="w-vis" style="font-size:1.5rem; font-weight:bold; color:#10b981;">-- km</div>
                    <small style="color:#94a3b8;">Clear View</small>
                </div>
            </div>

            <!-- COPIED: Traffic Monitor (Citizen Version) -->
            <div style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--text-main);">üö¶ Traffic Congestion Monitor</h3>
                <div class="traffic-controls card" style="margin-bottom: 1.5rem; padding: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                        <div style="flex: 1; min-width: 200px;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">Latitude:</label>
                            <input type="text" id="cit-traffic-latitude" value="28.6139"
                                style="width: 100%; padding: 0.6rem; border: 2px solid var(--card-border); border-radius: 6px; font-size: 0.95rem; background: var(--bg-color); color: var(--text-main);">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label
                                style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">Longitude:</label>
                            <input type="text" id="cit-traffic-longitude" value="77.2090"
                                style="width: 100%; padding: 0.6rem; border: 2px solid var(--card-border); border-radius: 6px; font-size: 0.95rem; background: var(--bg-color); color: var(--text-main);">
                        </div>
                        <button id="cit-fetchTrafficBtn" class="btn-primary" style="padding: 0.6rem 1.5rem;">Check
                            Status</button>
                    </div>
                </div>
                <!-- Simple Result Area for Citizen Tab -->
                <div id="cit-traffic-results" class="card" style="display:none; text-align:center;">
                    <h3>Traffic Status</h3>
                    <div id="cit-traffic-status" style="font-size:1.5rem; font-weight:bold;">--</div>
                    <div id="cit-traffic-details"></div>
                </div>
            </div>

            <!-- AQI & Safety Section -->
            <div class="dashboard-grid" style="margin-top:2rem;">

                <div class="card">
                    <h3>Top AQI Hotspots</h3>
                    <!-- Unique ID for Citizen Tab -->
                    <div id="cit-aqi-hotspots-list" style="min-height: 100px;">Loading hotspots...</div>
                </div>

            </div>
        </div>
    </div>

    <!-- Station Detail Modal -->
    <div id="station-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 id="modal-station-name" style="margin-top:0;">Station Details</h2>
            <div id="modal-station-location" style="color:var(--text-muted); margin-bottom:1rem;">Location</div>

            <div
                style="display:flex; align-items:center; gap:1rem; margin-bottom:2rem; background:#f8fafc; padding:1.5rem; border-radius:12px;">
                <div>
                    <div style="font-size:0.9rem; font-weight:600; color:var(--text-muted);">AQI INDEX</div>
                    <div id="modal-aqi" style="font-size:2.5rem; font-weight:800;">--</div>
                </div>
                <div style="flex:1; border-left:2px solid #e2e8f0; padding-left:1.5rem;">
                    <div style="font-size:0.9rem; font-weight:600; color:var(--text-muted);">PREDOMINANT</div>
                    <div id="modal-predominant" style="font-size:1.5rem; font-weight:700; color:var(--primary-color);">
                        --</div>
                </div>
            </div>

            <h3 style="font-size:1rem;">Pollutant Breakdown</h3>
            <div id="modal-pollutants" class="pollutant-grid">
                <!-- details injected here -->
            </div>
            <div style="margin-top: 1.5rem; font-size: 0.8rem; color: #ccc; text-align: right;" id="modal-updated">
            </div>
        </div>
    </div>

    <!-- Custom JS -->

    <script src="{% static 'core/js/app.js' %}"></script>
</body>

</html>